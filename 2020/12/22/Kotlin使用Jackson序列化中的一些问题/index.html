<!DOCTYPE html>
<html lang="cn">
<head>
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">

<!--ＪQuery-->
<script src="/Module/JQuery/jquery.min.js"></script>

<!--Vue.js-->
<script src="/Module/vue/vue.js"></script>
<!--饿了么Ｕi-->
<link rel="stylesheet" href="/Module/ElementUi/css/index.css">
<script src="/Module/ElementUi/index.js"></script>

<!--highlight-->
<link rel="stylesheet" href="/Module/highlight/css/zenburn.css">
<script src="/Module/highlight/highlight.min.js"></script>

<!--axios-->
<script src="/Module/axios/axios.min.js"></script>

<!--评论-->
<script src="/Module/comment/valine/Valine.min.js"></script>

<!--主题样式-->
<link rel="stylesheet" href="/Module/style.css">

<!--设置页面描述与关键字,封面图片-->

    <meta name="description" content="为了在项目中方便的使用Redis缓存，本来是准备使用Spring中的@Cacheaable等注解，经实验发现不支持Kotlin协程的suspend方法，所以便借助Kotlin算是写了一个缓存的DSL，在完成Spring提供的基本的cache功能还增加了batch cache和gloable cache，目前还有些问题没有解决，等解决掉会单独出一篇文章来介绍，这篇文章主要是介绍了在写这个缓存DSL的时候遇到的Jackson序列化Kotlin的类的问题。" />
    <meta name="keywords" content="" />
    <title>Kotlin使用Jackson序列化中的一些问题</title>
    
    <style>
        #content #title {
            background-image: url('/background.jpg');
        }
    </style>
    

</head>
<body>
    <div id="app" v-cloak>
    <div id="content">
        <el-button type="text" id="nav" icon="el-icon-tickets" @click="visible = !visible"></el-button>
<el-dialog :visible.sync="visible"  title="前往">
    <el-input id="searchInput" v-model="input" placeholder="请输入内容"></el-input>
    <div id="searchResult"></div>

    <br>
    <div id="Menu">
      <div class="grid-content bg-purple"><el-button><el-link :underline="false" href="/">首页</el-link></el-button></div>
      <div class="grid-content bg-purple"><el-button><el-link :underline="false" href="/archive/">归档</el-link></el-button></div>
      <div class="grid-content bg-purple"><el-button><el-link :underline="false" href="/about/">关于</el-link></el-button></div>
      <div class="grid-content bg-purple"><el-button><el-link :underline="false" href="/ly/">留言</el-link></el-button></div>
      <div class="grid-content bg-purple"><el-button><el-link :underline="false" href="/categories/">分类</el-link></el-button></div>
      <div class="grid-content bg-purple"><el-button><el-link :underline="false" href="/tages/">标签</el-link></el-button></div>
    </div>

</el-dialog>

<el-link href="#top"  id="toTop" class="show" :underline="false" icon="el-icon-top" ></el-link>



        
        <div id="title">
            <h1>
                Kotlin使用Jackson序列化中的一些问题<br>
                
                <p>作者：wz<br>编写：2020-12-22</p>
            </h1>
        </div>
        

        <div id="article">
            <meta name="referrer" content="no-referrer">

<h3 id="问题复现"><a href="#问题复现" class="headerlink" title="问题复现"></a>问题复现</h3><p>在实现自定义的缓存DSL中的RedisCache模块的时候，序列化这里是参考SpringBoot中RedisCache的来的，使用的是RedisSerializer.json()，点进去其实是如下：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> GenericJackson2JsonRedisSerializer(<span class="meta">@Nullable</span> String classPropertyTypeName) &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>(new ObjectMapper());</span><br><span class="line"></span><br><span class="line">  <span class="comment">// simply setting &#123;@code mapper.disable(SerializationFeature.FAIL_ON_EMPTY_BEANS)&#125; does not help here since we need</span></span><br><span class="line">  <span class="comment">// the type hint embedded for deserialization using the default typing feature.</span></span><br><span class="line">  registerNullValueSerializer(mapper, classPropertyTypeName);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (StringUtils.hasText(classPropertyTypeName)) &#123;</span><br><span class="line">    mapper.enableDefaultTypingAsProperty(DefaultTyping.NON_FINAL, classPropertyTypeName);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    mapper.enableDefaultTyping(DefaultTyping.NON_FINAL, As.PROPERTY);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这次的设计思路是需要保证我们的数据既要存到redis，又要能从redis中序列化出来，即进去的是一个对象，出来的还是那个对象。这种情况下 RedisSerializer.json()会把类的信息给输出到Json结构中，然后反序列化的时候就知道是哪个类了，如下面所示：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="attr">"@class"</span>:<span class="string">"com.bybutter.sisyphus.middleware.cache.redis.Test"</span>,<span class="attr">"a"</span>:<span class="string">"a"</span>,<span class="attr">"b"</span>:<span class="string">"b"</span>&#125;</span><br></pre></td></tr></table></figure>
<p>但是当我使用Kotlin的data class的时候，却怎么也不能进行序列化，输出的Json是不带@class的。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="attr">"a"</span>:<span class="string">"a"</span>,<span class="attr">"b"</span>:<span class="string">"b"</span>&#125;</span><br></pre></td></tr></table></figure>
<h3 id="问题解决"><a href="#问题解决" class="headerlink" title="问题解决"></a>问题解决</h3><p>我们点进去GenericJackson2JsonRedisSerializer类会发现，其中有个属性是ObjectMapper.DefaultTyping.NON_FINAL，但是我在前面Kotlin入门-class那篇文章中也说过了，Kotlin的class默认都是Final的，然后点进去这个枚举发现有如下属性：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> DefaultTyping &#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * This value means that only properties that have</span></span><br><span class="line"><span class="comment">         * &#123;<span class="doctag">@link</span> java.lang.Object&#125; as declared type (including</span></span><br><span class="line"><span class="comment">         * generic types without explicit type) will use default</span></span><br><span class="line"><span class="comment">         * typing.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        JAVA_LANG_OBJECT,</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Value that means that default typing will be used for</span></span><br><span class="line"><span class="comment">         * properties with declared type of &#123;<span class="doctag">@link</span> java.lang.Object&#125;</span></span><br><span class="line"><span class="comment">         * or an abstract type (abstract class or interface).</span></span><br><span class="line"><span class="comment">         * Note that this does &lt;b&gt;not&lt;/b&gt; include array types.</span></span><br><span class="line"><span class="comment">         *&lt;p&gt;</span></span><br><span class="line"><span class="comment">         * Since 2.4, this does NOT apply to &#123;<span class="doctag">@link</span> TreeNode&#125; and its subtypes.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        OBJECT_AND_NON_CONCRETE,</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Value that means that default typing will be used for</span></span><br><span class="line"><span class="comment">         * all types covered by &#123;<span class="doctag">@link</span> #OBJECT_AND_NON_CONCRETE&#125;</span></span><br><span class="line"><span class="comment">         * plus all array types for them.</span></span><br><span class="line"><span class="comment">         *&lt;p&gt;</span></span><br><span class="line"><span class="comment">         * Since 2.4, this does NOT apply to &#123;<span class="doctag">@link</span> TreeNode&#125; and its subtypes.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        NON_CONCRETE_AND_ARRAYS,</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Value that means that default typing will be used for</span></span><br><span class="line"><span class="comment">         * all non-final types, with exception of small number of</span></span><br><span class="line"><span class="comment">         * "natural" types (String, Boolean, Integer, Double), which</span></span><br><span class="line"><span class="comment">         * can be correctly inferred from JSON; as well as for</span></span><br><span class="line"><span class="comment">         * all arrays of non-final types.</span></span><br><span class="line"><span class="comment">         *&lt;p&gt;</span></span><br><span class="line"><span class="comment">         * Since 2.4, this does NOT apply to &#123;<span class="doctag">@link</span> TreeNode&#125; and its subtypes.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        NON_FINAL,</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Value that means that default typing will be used for</span></span><br><span class="line"><span class="comment">         * all non-final types, with exception of small number of</span></span><br><span class="line"><span class="comment">         * "natural" types (String, Boolean, Integer, Double) that</span></span><br><span class="line"><span class="comment">         * can be correctly inferred from JSON, and primitives (which</span></span><br><span class="line"><span class="comment">         * can not be polymorphic either). Typing is also enabled for</span></span><br><span class="line"><span class="comment">         * all array types.</span></span><br><span class="line"><span class="comment">         *&lt;p&gt;</span></span><br><span class="line"><span class="comment">         * Note that the only known use case for this setting is for serialization</span></span><br><span class="line"><span class="comment">         * when passing instances of final class, and base type is not</span></span><br><span class="line"><span class="comment">         * separately specified.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@since</span> 2.10</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        EVERYTHING</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>在Jackson-databind的issue中有人问到过类似的<a href="https://github.com/FasterXML/jackson-databind/issues/2349" target="_blank" rel="noopener">问题</a> 然后官方的回答如下：</p>
<p><img src="https://tva1.sinaimg.cn/large/0081Kckwly1glyp59m0xtj31ay0ak76h.jpg" alt="image-20201224093846624"></p>
<p>然后就加了一种叫EVERYTHING的类型，好吧。。。挺省事的。</p>
<p>然后就配置了objectMapper 如下：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GenericJackson2JsonRedisSerializer(ObjectMapper().apply &#123;</span><br><span class="line">        <span class="keyword">this</span>.registerKotlinModule()</span><br><span class="line">        <span class="keyword">this</span>.setSerializationInclusion(JsonInclude.Include.NON_NULL)</span><br><span class="line">        <span class="keyword">this</span>.configure(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES, <span class="literal">false</span>)</span><br><span class="line">        <span class="keyword">this</span>.configure(JsonParser.Feature.IGNORE_UNDEFINED, <span class="literal">true</span>)</span><br><span class="line">        <span class="keyword">this</span>.configure(JsonGenerator.Feature.IGNORE_UNKNOWN, <span class="literal">true</span>)</span><br><span class="line">        <span class="keyword">this</span>.activateDefaultTyping(BasicPolymorphicTypeValidator.builder().allowIfBaseType(Any::<span class="class"><span class="keyword">class</span>.<span class="title">java</span>).<span class="title">build</span></span>(), ObjectMapper.DefaultTyping.EVERYTHING)</span><br><span class="line">    &#125;)</span><br></pre></td></tr></table></figure>
<p>然后就又出现了新的错误:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java.lang.UnsupportedOperationException: com.fasterxml.jackson.databind.JsonMappingException: <span class="function">Unexpected <span class="title">token</span> <span class="params">(START_OBJECT)</span>, expected VALUE_STRING: need JSON String that contains type <span class="title">id</span> <span class="params">(<span class="keyword">for</span> subtype of java.util.List)</span></span></span><br></pre></td></tr></table></figure>
<p>然后搜了一下，结果查到的解决办法全是不用enableDefaultTyping，这。。也有点简单粗暴，肯定是不可取的然后点进去看了下类的构造，大致错误定位到错误是另外一个直接使用默认属性，默认的为JsonTypeInfo.As.WRAPPER_ARRAY，这样就会导致对象会被序列化成数组。然后改成JsonTypeInfo.As.PROPERTY就可以了。</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>​    这次的问题虽然是我自己写的缓存的DSL过程中发现的，但是对于正常的使用Kotlin的Spring Boot的项目来说在使用@Cacheable的注解的时候，自定义序列化器的时候要注意一下。其实还有一种解决办法，我在前面Kotlin类的那一篇文章也说了使用all-open插件，这样也是可以的</p>
<p>​    其实这次的问题不是很难，内容也不是很多，但是网上相关资料很少，尤其是中文资料，应该同时使用Kotlin和Spring Boot的人不多吧，但是Kotlin真的是一门优秀的语言，在Spring Boot中使用也是很丝滑的，希望以后这么用的人越来越多，也更加希望我们在使用过程中踩过的坑能为后来者提供一个解决方案，少踩一些坑。</p>
<p>参考：[<a href="https://stackoverflow.com/questions/52265326/how-can-i-easily-cache-kotlin-objects-in-redis-using-json-via-jackson" target="_blank" rel="noopener">How can I easily cache Kotlin Objects in Redis using json via Jackson?</a>]</p>
   
            <br>
            <hr><br>
            
                <div id="article-previous">
                    <a href="/2021/03/01/Protocol-Buffer编码/" data-toggle="tooltip" data-placement="top" title="Protocol Buffer编码">&larr; 上一篇</a>
                </div>
                
                
                <div id="article-next">
                    <a href="/2020/12/12/RocketMQ消息追踪相关源码分析/" data-toggle="tooltip" data-placement="top" title="RocketMQ消息追踪相关源码分析">下一篇 &rarr;</a>
                </div>
            
            <br><br>
            <hr>
        </div>
    </div>

    <div id="comment">
        
        
    <h2>留言</h2>
    <div id="vcomments">
    </div>
    <script>
        var valine = new Valine({
        el: '#vcomments', 
        appId: 'HfM9lGHkjvrCY4Y00sfk4TbY-gzGzoHsz',
        appKey: 'yzGGVla3JWB1CeQ6dIECEGVc',
    
        emojiCDN: 'https://i0.hdslb.com/bfs/emote/', 
        emojiMaps: {
          "tv_doge": "6ea59c827c414b4a2955fe79e0f6fd3dcd515e24.png",
          "tv_亲亲": "a8111ad55953ef5e3be3327ef94eb4a39d535d06.png",
          "tv_偷笑": "bb690d4107620f1c15cff29509db529a73aee261.png",
          "tv_再见": "180129b8ea851044ce71caf55cc8ce44bd4a4fc8.png",
          "tv_冷漠": "b9cbc755c2b3ee43be07ca13de84e5b699a3f101.png",
          "tv_发怒": "34ba3cd204d5b05fec70ce08fa9fa0dd612409ff.png",
          "tv_发财": "34db290afd2963723c6eb3c4560667db7253a21a.png",
          "tv_可爱": "9e55fd9b500ac4b96613539f1ce2f9499e314ed9.png",
          "tv_吐血": "09dd16a7aa59b77baa1155d47484409624470c77.png",
          "tv_呆": "fe1179ebaa191569b0d31cecafe7a2cd1c951c9d.png",
          "tv_呕吐": "9f996894a39e282ccf5e66856af49483f81870f3.png",
          "tv_困": "241ee304e44c0af029adceb294399391e4737ef2.png",
          "tv_坏笑": "1f0b87f731a671079842116e0991c91c2c88645a.png",
          "tv_大佬": "093c1e2c490161aca397afc45573c877cdead616.png",
          "tv_大哭": "23269aeb35f99daee28dda129676f6e9ea87934f.png",
          "tv_委屈": "d04dba7b5465779e9755d2ab6f0a897b9b33bb77.png",
          "tv_害羞": "a37683fb5642fa3ddfc7f4e5525fd13e42a2bdb1.png",
          "tv_尴尬": "7cfa62dafc59798a3d3fb262d421eeeff166cfa4.png",
          "tv_微笑": "70dc5c7b56f93eb61bddba11e28fb1d18fddcd4c.png",
          "tv_思考": "90cf159733e558137ed20aa04d09964436f618a1.png",
          "tv_惊吓": "0d15c7e2ee58e935adc6a7193ee042388adc22af.png",
        }
    })
    </script>

    
    
    
     
    </div>
</div>
    <script src="/Module/main.js"></script>
</body>
</html>